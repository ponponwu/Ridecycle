# 整合測試情境詳細說明

## 📋 測試覆蓋範圍總覽

本專案實現了全方位的整合測試，涵蓋以下三個層級：

### 🔧 1. 後端 API 整合測試 (Rails RSpec)

-   **檔案位置**: `backend/spec/integration/`
-   **測試工具**: RSpec, FactoryBot, Database Cleaner
-   **測試重點**: API 端點、業務邏輯、資料庫交互

### ⚛️ 2. 前端組件整合測試 (React Testing Library)

-   **檔案位置**: `frontend/src/test/integration/`
-   **測試工具**: Vitest, React Testing Library, Jest-DOM
-   **測試重點**: 組件交互、使用者流程、錯誤處理

### 🌐 3. 端到端測試 (Playwright)

-   **檔案位置**: `frontend/src/e2e/`
-   **測試工具**: Playwright
-   **測試重點**: 跨瀏覽器真實用戶體驗

---

## 🎯 測試情境詳細分類

### 核心功能測試

#### 1. 使用者認證與授權流程

-   **測試檔案**: `user_workflow_spec.rb`, `userWorkflow.test.tsx`
-   **涵蓋情境**:
    -   ✅ 用戶註冊流程
    -   ✅ 用戶登入/登出
    -   ✅ 密碼錯誤處理
    -   ✅ 認證狀態管理
    -   ✅ 未授權訪問攔截

#### 2. 腳踏車商品管理

-   **測試檔案**: `user_workflow_spec.rb`, `realWorldScenarios.test.tsx`
-   **涵蓋情境**:
    -   ✅ 商品上架流程
    -   ✅ 商品詳情查看
    -   ✅ 商品搜索和篩選
    -   ✅ 商品狀態管理 (available, sold, reserved)
    -   ✅ 商品圖片上傳和顯示

#### 3. 訊息和出價系統

-   **測試檔案**: `user_workflow_spec.rb`, `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ 一般訊息發送
    -   ✅ 出價訊息發送
    -   ✅ 出價接受/拒絕
    -   ✅ 對話記錄管理
    -   ✅ 即時訊息更新

### 業務邏輯測試

#### 4. 交易安全與防護

-   **測試檔案**: `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **防止自己對自己出價**: 確保用戶無法對自己發布的商品出價
    -   ✅ **重複出價防護**: 防止用戶對同一商品重複出價
    -   ✅ **異常出價檢測**: 識別和處理異常低價或高價出價
    -   ✅ **垃圾訊息過濾**: 防止廣告或外部聯絡方式
    -   ✅ **惡意用戶行為**: 防止出價後立即撤回等行為

#### 5. 多用戶競爭場景

-   **測試檔案**: `user_workflow_spec.rb`, `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **搶購情境**: 多個買家同時對熱門商品出價
    -   ✅ **價格競爭**: 買家之間的出價競爭
    -   ✅ **同時交易**: 不同用戶同時進行不同商品交易
    -   ✅ **庫存管理**: 確保商品只能被一人購買

#### 6. 砍價談判流程

-   **測試檔案**: `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **初步詢問**: 買家詢問商品狀況
    -   ✅ **第一次出價**: 通常較低的試探性出價
    -   ✅ **賣家回應**: 拒絕或反提案
    -   ✅ **再次出價**: 買家提高價格
    -   ✅ **最終成交**: 雙方達成協議
    -   ✅ **對話記錄**: 完整保存談判過程

### 真實情境模擬

#### 7. 不同類型用戶行為

-   **測試檔案**: `realWorldScenarios.test.tsx`
-   **涵蓋情境**:
    -   ✅ **新手買家**: 謹慎詢問、小心出價、預算有限
    -   ✅ **資深車友**: 快速決策、直接出價、專業判斷
    -   ✅ **收藏家**: 詳細詢問、精密評估、高價商品
    -   ✅ **賣家視角**: 同時管理多個詢問、優先處理出價

#### 8. 商品管理情境

-   **測試檔案**: `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **多商品管理**: 賣家同時管理不同類型商品
    -   ✅ **分類詢問**: 針對不同商品類型的專業詢問
    -   ✅ **優先級處理**: 賣家優先處理高價值出價
    -   ✅ **商品狀態同步**: 確保商品狀態即時更新

#### 9. 促銷活動情境

-   **測試檔案**: `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **節慶促銷**: 雙 11、黑五等大型促銷活動
    -   ✅ **搶購高峰**: 短時間內大量用戶同時操作
    -   ✅ **限時特價**: 特定時間內的優惠活動
    -   ✅ **庫存壓力**: 高併發下的數據一致性

#### 10. 客服與糾紛處理

-   **測試檔案**: `real_world_scenarios_spec.rb`
-   **涵蓋情境**:
    -   ✅ **商品描述不符**: 實際商品與描述不一致
    -   ✅ **價格重新協商**: 發現問題後的補償談判
    -   ✅ **退款流程**: 交易取消的處理
    -   ✅ **對話記錄保存**: 糾紛證據保全

### 技術場景測試

#### 11. 設備適配性

-   **測試檔案**: `realWorldScenarios.test.tsx`, `userWorkflow.spec.ts`
-   **涵蓋情境**:
    -   ✅ **桌面瀏覽器**: Chrome, Firefox, Safari
    -   ✅ **行動設備**: iPhone, Android 手機
    -   ✅ **平板設備**: iPad, Android 平板
    -   ✅ **響應式設計**: 不同螢幕尺寸適配

#### 12. 網路環境測試

-   **測試檔案**: `realWorldScenarios.test.tsx`
-   **涵蓋情境**:
    -   ✅ **網路斷線**: 處理網路中斷情況
    -   ✅ **重新連接**: 自動或手動重連
    -   ✅ **慢速網路**: 2G/3G 網路環境
    -   ✅ **離線功能**: 部分功能離線可用

#### 13. 錯誤處理與恢復

-   **測試檔案**: `user_workflow_spec.rb`, `realWorldScenarios.test.tsx`
-   **涵蓋情境**:
    -   ✅ **API 錯誤**: 500, 404, 403 等錯誤處理
    -   ✅ **表單驗證**: 輸入錯誤的友善提示
    -   ✅ **重試機制**: 失敗後的自動重試
    -   ✅ **錯誤回復**: 錯誤後的正常流程恢復

---

## 📊 測試數據統計

### 後端測試覆蓋

-   **總測試案例**: 15+ 個主要情境
-   **API 端點**: 20+ 個測試端點
-   **錯誤情境**: 10+ 種錯誤處理
-   **性能測試**: 併發用戶模擬

### 前端測試覆蓋

-   **組件測試**: 25+ 個核心組件
-   **用戶流程**: 8+ 個完整流程
-   **交互測試**: 15+ 種用戶交互
-   **響應式測試**: 3+ 種設備尺寸

### 端到端測試覆蓋

-   **瀏覽器支援**: 3+ 主流瀏覽器
-   **設備測試**: 5+ 種設備配置
-   **完整流程**: 10+ 個端到端流程
-   **真實情境**: 8+ 種真實使用情境

---

## 🎯 測試執行指令

### 後端測試

```bash
cd backend

# 執行所有整合測試
bundle exec rspec spec/integration/

# 執行特定測試檔案
bundle exec rspec spec/integration/user_workflow_spec.rb
bundle exec rspec spec/integration/real_world_scenarios_spec.rb

# 產生測試報告
bundle exec rspec --format html --out spec/reports/integration_tests.html
```

### 前端測試

```bash
cd frontend

# 執行所有整合測試
npm run test:integration

# 執行特定測試檔案
npm run test -- userWorkflow.test.tsx
npm run test -- realWorldScenarios.test.tsx

# 產生覆蓋率報告
npm run test:coverage
```

### 端到端測試

```bash
cd frontend

# 執行所有 E2E 測試
npx playwright test

# 執行特定瀏覽器
npx playwright test --project=chromium

# 有頭模式（可視化）
npx playwright test --headed

# 產生報告
npx playwright show-report
```

---

## 🚀 持續改進計畫

### 短期目標

-   [x] 完成核心功能測試
-   [x] 實現真實情境模擬
-   [ ] 修正測試環境設定問題
-   [ ] 提高測試覆蓋率到 90%+

### 中期目標

-   [ ] 添加性能測試
-   [ ] 實現視覺回歸測試
-   [ ] 增加多語言測試
-   [ ] 完善 CI/CD 整合

### 長期目標

-   [ ] 實現自動化測試報告
-   [ ] 建立測試監控儀表板
-   [ ] 添加負載測試
-   [ ] 實現混沌工程測試

---

## 📝 測試維護注意事項

### 測試資料管理

-   每次測試後自動清理資料
-   使用 Factory 模式生成測試資料
-   避免測試之間的資料污染

### 測試環境一致性

-   確保測試環境與生產環境一致
-   定期更新測試依賴
-   監控測試執行時間

### 測試品質保證

-   定期檢查測試有效性
-   移除過時或重複的測試
-   保持測試代碼的可讀性

### 問題追蹤

-   記錄測試失敗原因
-   建立測試失敗處理流程
-   定期分析測試趨勢

---

**最後更新**: 2024 年 1 月
**維護者**: 開發團隊
**版本**: 1.0
