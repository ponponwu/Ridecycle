# Enhanced Zeabur Configuration - 增強版配置
# 包含更多安全和性能優化功能

# 速率限制區域定義 (如果 Zeabur 支援全域配置)
# 注意: 這些指令通常在 http 區塊中，但 Zeabur 可能不支援
# limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
# limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;

# WebSocket 支援映射
map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name _; # Zeabur 自動處理域名和 SSL

    # 禁用 AIO 以防止某些環境中的 io_setup() 錯誤
    aio off;

    root /usr/share/nginx/html;
    index index.html index.htm;

    # 增強安全標頭配置
    # Content Security Policy - 更嚴格的 XSS 防護
    add_header Content-Security-Policy "
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gpteng.co https://apis.google.com https://accounts.google.com;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
        font-src 'self' https://fonts.gstatic.com data:;
        img-src 'self' data: https: blob:;
        connect-src 'self' https://accounts.google.com;
        frame-src 'self' https://accounts.google.com;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
        frame-ancestors 'none';
        upgrade-insecure-requests;
        block-all-mixed-content;
    " always;

    # 增強的 HSTS 設定
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    
    # 防止點擊劫持
    add_header X-Frame-Options "DENY" always;
    
    # 防止 MIME 類型嗅探
    add_header X-Content-Type-Options "nosniff" always;
    
    # XSS 保護 (雖然較新瀏覽器已棄用，但保持相容性)
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Referrer 政策
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # 增強的權限政策
    add_header Permissions-Policy "
        accelerometer=(),
        ambient-light-sensor=(),
        autoplay=(self),
        battery=(),
        camera=(),
        clipboard-read=(),
        clipboard-write=(self),
        display-capture=(),
        document-domain=(),
        encrypted-media=(),
        execution-while-not-rendered=(),
        execution-while-out-of-viewport=(),
        fullscreen=(self),
        geolocation=(),
        gyroscope=(),
        magnetometer=(),
        microphone=(),
        midi=(),
        navigation-override=(),
        payment=(),
        picture-in-picture=(),
        publickey-credentials-get=(),
        screen-wake-lock=(),
        sync-xhr=(),
        usb=(),
        web-share=(self),
        xr-spatial-tracking=()
    " always;

    # Cross-Origin 政策
    add_header Cross-Origin-Embedder-Policy "require-corp" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;

    # API 代理設定 - 包含速率限制
    location /api/ {
        # 速率限制 (如果支援)
        # limit_req zone=api_limit burst=20 nodelay;
        
        # 移除 /api 前綴並轉發到後端
        rewrite ^/api/(.*) /$1 break;
        
        # 內部服務通訊
        proxy_pass http://backend:3000;
        
        # 增強的代理標頭設定
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
        
        # 逾時設定
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 代理緩衝設定
        proxy_buffering off;
        proxy_request_buffering off;
        
        # WebSocket 支援
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        
        # 代理快取控制
        proxy_cache_bypass $http_upgrade;
        
        # 錯誤處理
        proxy_intercept_errors on;
        error_page 502 503 504 /api_error.html;
    }

    # 健康檢查端點
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # SPA 路由處理 - 包含速率限制
    location / {
        # 一般頁面速率限制 (如果支援)
        # limit_req zone=general_limit burst=50 nodelay;
        
        try_files $uri $uri/ /index.html;
    }

    # index.html 特殊處理 - 防快取
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate, proxy-revalidate";
        add_header Pragma "no-cache";
        expires 0;
        
        # 重複安全標頭 (location 特定)
        add_header Content-Security-Policy "
            default-src 'self';
            script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.gpteng.co https://apis.google.com https://accounts.google.com;
            style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
            font-src 'self' https://fonts.gstatic.com data:;
            img-src 'self' data: https: blob:;
            connect-src 'self' https://accounts.google.com;
            frame-src 'self' https://accounts.google.com;
            object-src 'none';
            base-uri 'self';
            form-action 'self';
            frame-ancestors 'none';
            upgrade-insecure-requests;
            block-all-mixed-content;
        " always;
        
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    }

    # 靜態資源優化設定
    location ~* \.(?:css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable, stale-while-revalidate=31536000";
        access_log off;
        
        # 安全標頭
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
        
        # Brotli 壓縮支援 (如果可用)
        gzip_static on;
    }

    # 圖片和字體資源
    location ~* \.(?:jpg|jpeg|gif|png|ico|svg|webp|avif)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        
        # 安全標頭
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
    }

    # 字體檔案
    location ~* \.(?:woff|woff2|ttf|eot|otf)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        access_log off;
        
        # 安全標頭
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;
    }

    # 阻止訪問敏感檔案
    location ~* /\.(?:htaccess|htpasswd|git|svn|env) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # 阻止訪問備份檔案
    location ~* \.(?:bak|backup|old|orig|save|swp|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # robots.txt 和 sitemap.xml
    location = /robots.txt {
        access_log off;
        log_not_found off;
    }

    location = /sitemap.xml {
        access_log off;
        log_not_found off;
    }

    # 隱藏 nginx 版本
    server_tokens off;

    # 增強的 Gzip 壓縮
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_min_length 1000;
    
    gzip_types
        application/atom+xml
        application/geo+json
        application/javascript
        application/x-javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rdf+xml
        application/rss+xml
        application/xhtml+xml
        application/xml
        font/eot
        font/otf
        font/ttf
        image/svg+xml
        text/css
        text/javascript
        text/plain
        text/xml
        text/x-component
        text/x-cross-domain-policy;

    # 自定義錯誤頁面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        internal;
    }
    
    location = /50x.html {
        internal;
    }
    
    location = /api_error.html {
        internal;
    }
}